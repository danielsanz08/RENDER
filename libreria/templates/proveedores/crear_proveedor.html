{% extends "navbar.html" %}
{% block titulo %}Crear Proveedor{% endblock %}
{% block contenido %}
{% load static %}

<link href="{% static 'css/crear_proveedor.css' %}?v={% now 'U' %}" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<div class="container">
    <div class="login wrap">
        <h1 title="Agregar proveedor">AGREGAR PROVEEDOR</h1>

        <form method="post" id="crear-proveedor-form">
            {% csrf_token %}

            <!-- NIT -->
            <div class="nit_input">
                <label for="nit" title="NIT">NIT</label>
                <input type="text" name="nit" id="nit" class="form-control" placeholder="NIT" required maxlength="10">
                <p id="nit_mensaje" class="text-danger"></p>
            </div>

            <!-- Tipo de persona -->
            <div class="tipo_persona_input">
                <label for="tipo_persona" title="Tipo de persona">Tipo de Persona</label>
                <select name="tipo_persona" id="tipo_persona" class="form-control">
                    <option value="">Seleccione tipo de persona</option>
                    <option value="Persona Jurídica">Persona Jurídica</option>
                    <option value="Persona Natural">Persona Natural</option>
                </select>
            </div>

            <!-- Nombre -->
            <div class="name_input">
                <label for="nombre" title="Nombre del proveedor">Nombre del Proveedor</label>
                <input type="text" name="nombre" id="nombre" class="form-control" placeholder="Nombre del Proveedor"
                    required>
                <p id="nombre_mensaje" class="text-danger"></p>
            </div>

            <!-- Dirección -->
            <div class="direccion_input">
                <label for="direccion" title="Dirección">Dirección</label>
                <input type="text" name="direccion" id="direccion" class="form-control" placeholder="Dirección"
                    required>
            </div>

            <!-- Email -->
            <div class="email_input">
                <label for="email" title="Correo electrónico">Correo Electrónico</label>
                <input type="email" name="email" id="email" class="form-control" placeholder="Correo Electrónico"
                    required>
            </div>

            <!-- Teléfono -->
            <div class="form-group">
                <label for="telefono" title="Teléfono">Teléfono</label>
                <input maxlength="10" type="text" name="telefono" id="telefono" class="form-control"
                    placeholder="Teléfono">
                <p id="telefono_mensaje" class="text-danger"></p>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-success" title="Registrar proveedor">Registrar Proveedor</button>
                <a href="{% url 'libreria:insumos' %}" class="btn btn-warning" role="button" title="Volver">Volver</a>
            </div>
        </form>

        <!-- Popup -->
        <div id="popup" class="popup">
            <div class="checkmark">
                <svg class="checkmark-svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
                    <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16" />
                </svg>
                <p>Registro Exitoso</p>
            </div>

        </div>
    </div>
</div>

<script>

    const inputNit = document.getElementById("nit");
    const mensajeNit = document.getElementById("nit_mensaje");

    const inputNombre = document.getElementById("nombre");
    const mensajeNombre = document.getElementById("nombre_mensaje");

    const inputTelefono = document.getElementById("telefono");
    const mensajeTelefono = document.getElementById("telefono_mensaje");

    const inputDireccion = document.getElementById("direccion");
    let mensajeDireccion = document.createElement("p");
    mensajeDireccion.className = "text-danger";
    inputDireccion.parentNode.appendChild(mensajeDireccion);


    /* VALIDACIÓN NIT  */
    inputNit.addEventListener("input", () => {
        let valueNit = inputNit.value.replace(/[^0-9]/g, "").trim();
        inputNit.value = valueNit;

        if (valueNit === "") {
            mensajeNit.textContent = "";
            return;
        }

        // 4 o más repetidos
        if (/(.)\1{3,}/.test(valueNit)) {
            mensajeNit.textContent = "No se permiten 4 o más números repetidos consecutivamente";
            return;
        }

        // Validar en DB
        fetch(`/validad_nit/?nit=${valueNit}`)
            .then(r => r.json())
            .then(d => {
                mensajeNit.textContent = d.existe ? "NIT ya registrado" : "";
            })
            .catch(err => console.error("Error validando el NIT:", err));
    });


    /*  VALIDACIÓN NOMBRE */
    inputNombre.addEventListener("input", () => {
        let value = inputNombre.value.replace(/[^a-zA-ZÁÉÍÓÚáéíóúñÑ\s]/g, "");
        inputNombre.value = value;

        // 3 repetidos consecutivos
        if (/(.)\1{2,}/.test(value)) {
            mensajeNombre.textContent = "No se permiten 3 o más caracteres repetidos consecutivamente";
        } else {
            mensajeNombre.textContent = "";
        }
    });


    /*  VALIDACIÓN TELÉFONO */
    inputTelefono.addEventListener("input", () => {
        let value = inputTelefono.value.replace(/[^0-9]/g, "");
        inputTelefono.value = value;

        // 4 repetidos consecutivos
        if (/(.)\1{3,}/.test(value)) {
            mensajeTelefono.textContent = "No se permiten 4 o más números repetidos consecutivamente";
        } else {
            mensajeTelefono.textContent = "";
        }
    });


    /*  VALIDACIÓN DIRECCIÓN  */
    inputDireccion.addEventListener("input", () => {

        // Permitir letras, números, espacios, puntos, comas, guiones y # (muy típico en Colombia)
        let value = inputDireccion.value.replace(/[^a-zA-Z0-9ÁÉÍÓÚáéíóúñÑ\s\.,#-]/g, "");
        inputDireccion.value = value;

        //NO permitir dos caracteres repetidos consecutivamente
        if (/(.)\1{1,}/.test(value)) {
            mensajeDireccion.textContent = "No se permiten 2 o más caracteres repetidos consecutivamente";
        } else {
            mensajeDireccion.textContent = "";
        }
    });


    /* ENVÍO DEL FORMULARIO */
    document.getElementById('crear-proveedor-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // Evitar envío si hay errores
        if (
            mensajeNit.textContent ||
            mensajeNombre.textContent ||
            mensajeTelefono.textContent ||
            mensajeDireccion.textContent
        ) {
            alert("Corrige los errores antes de enviar.");
            return;
        }

        const formData = new FormData(this);
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;

        submitButton.disabled = true;
        submitButton.textContent = 'Enviando...';

        fetch('', {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(response => response.json())
            .then(data => {
                submitButton.disabled = false;
                submitButton.textContent = originalText;

                if (data.success) {

                    const popup = document.getElementById('popup');
                    popup.style.display = 'flex';

                    popup.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    setTimeout(() => {
                        window.location.href = "{% url 'libreria:listar_proveedor' %}";
                    }, 2000);

                } else {
                    alert('Por favor corrige los errores del formulario.');
                }
            })
            .catch(error => {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                alert('Error al enviar el formulario, intenta nuevamente.');
            });
    });

</script>


{% endblock %}
