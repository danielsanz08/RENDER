{% extends "navbar.html" %}
{% load static %}
{% block titulo %}Crear Producto{% endblock %}
{% block contenido %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link href="{% static 'css/crear_producto.css' %}?v={% now 'U' %}" rel="stylesheet"/>
<style>
    /* Estilos para el popup */
.popup {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    z-index: 9999;
}

/* Estilos de alertas (éxito y error) */
.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.checkmark {
    margin: 10px auto;
}

.checkmark-svg {
    width: 50px;
    height: 50px;
    stroke: #4CAF50;
    stroke-width: 4;
    stroke-linecap: round;
    stroke-linejoin: round;
}

.checkmark-circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    animation: drawCircle 0.6s ease-out forwards;
}

.checkmark-check {
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: drawCheck 0.3s 0.6s ease-out forwards;
}

@keyframes drawCircle {
    100% {
        stroke-dashoffset: 0;
    }
}

@keyframes drawCheck {
    100% {
        stroke-dashoffset: 0;
    }
}
</style>
<div class="container">
    <div class="login wrap">
        <h1 title="Agregar producto">AGREGAR PRODUCTO</h1>

        <form method="post" class="producto-form" id="productoForm">
            {% csrf_token %}
        
            <div class="form-group">
                <label for="nombre" title="Nombre del producto">Nombre del Producto</label>
                <input type="text" placeholder="Nombre" id="nombre" name="nombre" required title="Introduce el nombre del producto">
            </div>
        
            
        
            <div class="form-group">
                <label for="presentacion" title="Presentación">Presentación</label>
                <input type="text" placeholder="Presentación" id="presentacion" name="presentacion" required title="Introduce la presentación del producto">
            </div>
        
            <div class="form-group">
                <label for="unidad_medida" title="Unidad de medida">Unidad de Medida</label>
                <select id="unidad_medida" name="unidad_medida" required title="Selecciona una unidad de medida">
                    <option value="">Seleccione una opción</option>
                    <option value="litro" title="Litro">Litro (l)</option>
                    <option value="mililitro" title="Mililitro">Mililitro (ml)</option>
                    <option value="gramo" title="Gramo">Gramo (g)</option>
                    <option value="kilogramo" title="Kilogramo">Kilogramo (kg)</option>
                    <option value="unidad" title="Unidad">Unidad</option>
                </select>
            </div>
        
            <div class="form-group">
                <label for="cantidad" title="Cantidad">Cantidad</label>
                <input type="number" placeholder="Cantidad" id="cantidad" name="cantidad" min="1" step="1" required title="Introduce la cantidad del producto">
            </div>
        
            <div class="form-group">
                <label for="precio" title="Precio">Precio ($ COP)</label>
                <input type="number" placeholder="Precio" id="precio" name="precio" min="100" step="100" required title="Introduce el precio del producto">
            </div>
        
            <div class="form-group">
                <label for="fecha_elaboracion" title="Fecha de elaboración">Fecha de Elaboración</label>
                <input type="date" placeholder="Fecha de Elaboración" id="fecha_elaboracion" name="fecha_elaboracion" required title="Selecciona la fecha de elaboración del producto">
            </div>
        
            <div class="form-group">
                <label for="fecha_vencimiento" title="Fecha de vencimiento">Fecha de Vencimiento</label>
                <input type="date" placeholder="Fecha de Vencimiento" id="fecha_vencimiento" name="fecha_vencimiento" required title="Selecciona la fecha de vencimiento del producto">
            </div>
        
            <div class="form-group">
                <label for="temperatura_conservacion" title="Temperatura de conservación">Temperatura de Conservación (°C)</label>
                <input type="number" placeholder="Temperatura" id="temperatura_conservacion" name="temperatura_conservacion" min="-20" max="30" step="1" required title="Introduce la temperatura de conservación">
            </div>            
        
            <div class="form-group">
                <label for="lote" title="Número de lote">Número de Lote</label>
                <input type="text" placeholder="Número de Lote" id="lote" name="lote" required pattern="[A-Za-z0-9]+" title="Ingresa el número de lote del producto">
            </div>
        
            <div class="form-group">
                <label for="codigo" title="Código del producto">Código del Producto</label>
                <input maxlength="8" type="text" placeholder="Código" id="codigo" name="codigo" required pattern="[A-Za-z0-9]+" title="Ingresa el código del producto">
            </div>   
        
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" title="Crear producto">Crear Producto</button>
                <a href="{% url 'libreria:productos' %}" class="btn btn-secondary" title="Cancelar">Cancelar</a>
            </div>         
        </form>        

        <!-- Popup -->
        <div id="popup" class="popup">
            <div class="checkmark">
                <svg class="checkmark-svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16"/>
                </svg>
                            <p>Registro Exitoso</p>
            </div>
            
        </div>
                    
    </div>
</div>
<script>
// =============================================
// MENSAJE DE ERROR DINÁMICO
// =============================================
function crearMensajeError(input, id) {
    let msg = document.getElementById(id);
    if (!msg) {
        msg = document.createElement("p");
        msg.id = id;
        msg.style.color = "red";
        msg.style.fontSize = "14px";
        msg.style.marginTop = "5px";
        input.parentNode.appendChild(msg);
    }
    return msg;
}

// =============================================
// VALIDACIÓN CAMPOS DE TEXTO SIN NÚMEROS Y REPETIDOS
// =============================================
function validarTexto(input, mensajeId) {
    const mensajeError = crearMensajeError(input, mensajeId);

    input.addEventListener("input", function () {
        mensajeError.textContent = ""; // limpiar

        // Eliminar números
        const newValue = this.value.replace(/[0-9]/g, "");
        if (newValue !== this.value) {
            this.value = newValue;
        }

        // Detectar 3 o más caracteres repetidos consecutivamente
        const repetidos = /(.)\1{2,}/;

        if (repetidos.test(this.value)) {
            mensajeError.textContent = "No se permiten caracteres repetidos consecutivamente";
        }
    });
}

validarTexto(document.getElementById("nombre"), "errorNombre");
validarTexto(document.getElementById("presentacion"), "errorPresentacion");

// =============================================
// VALIDACIÓN SOLO NÚMEROS PARA LOTE Y CÓDIGO
// =============================================
function soloNumeros(input) {
    input.addEventListener("input", function () {
        this.value = this.value.replace(/[^0-9]/g, "");
    });
}

soloNumeros(document.getElementById("lote"));
soloNumeros(document.getElementById("codigo"));


// =============================================
// VALIDACIÓN Y ENVÍO DEL FORMULARIO
// =============================================
document.getElementById('productoForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // PREVENIR ENVÍO SI HAY REPETIDOS
    const repetidos = /(.)\1{2,}/;
    if (repetidos.test(document.getElementById("nombre").value) ||
        repetidos.test(document.getElementById("presentacion").value)) {

        alert("Corrige los campos con caracteres repetidos antes de enviar.");
        return;
    }

    const formData = new FormData(this);
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;

    submitButton.disabled = true;
    submitButton.textContent = 'Enviando...';

    fetch('', {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        submitButton.disabled = false;
        submitButton.textContent = originalText;

        if (data.success) {
            const popup = document.getElementById('popup');
            popup.style.display = 'flex';
            popup.scrollIntoView({ behavior: 'smooth', block: 'center' });

            setTimeout(() => {
                window.location.href = "{% url 'libreria:lista_productos' %}";
            }, 2000);

        } else {
            alert('Por favor corrige los errores en el formulario.');
        }
    })
    .catch(error => {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
        alert('Error al enviar el formulario. Inténtalo de nuevo.');
    });
});
</script>


{% endblock %}
