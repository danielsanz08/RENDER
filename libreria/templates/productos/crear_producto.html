{% extends "navbar.html" %}
{% load static %}
{% block titulo %}Crear Producto{% endblock %}
{% block contenido %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link href="{% static 'css/crear_producto.css' %}?v={% now 'U' %}" rel="stylesheet"/>

<div class="container">
    <div class="login wrap">
        <h1 title="Agregar producto">AGREGAR PRODUCTO</h1>

        <form method="post" class="producto-form" id="productoForm">
            {% csrf_token %}
        
            <div class="form-group">
                <label for="nombre" title="Nombre del producto">Nombre del Producto</label>
                <input type="text" placeholder="Nombre" id="nombre" name="nombre" required title="Introduce el nombre del producto">
            </div>
        
            <div class="form-group">
                <label for="categoria" title="Categoría">Categoría</label>
                <select id="categoria" name="categoria" required title="Selecciona una categoría">
                    <option value="">Seleccione una categoría</option>
                    <option value="leche" title="Leche">Leche</option>
                    <option value="queso" title="Queso">Queso</option>
                    <option value="mantequilla" title="Mantequilla">Mantequilla</option>
                    <option value="crema" title="Crema">Crema</option>
                    <option value="otros" title="Otros">Otros</option>
                </select>
            </div>
        
            <div class="form-group">
                <label for="presentacion" title="Presentación">Presentación</label>
                <input type="text" placeholder="Presentación" id="presentacion" name="presentacion" required title="Introduce la presentación del producto">
            </div>
        
            <div class="form-group">
                <label for="unidad_medida" title="Unidad de medida">Unidad de Medida</label>
                <select id="unidad_medida" name="unidad_medida" required title="Selecciona una unidad de medida">
                    <option value="">Seleccione una opción</option>
                    <option value="litro" title="Litro">Litro (l)</option>
                    <option value="mililitro" title="Mililitro">Mililitro (ml)</option>
                    <option value="gramo" title="Gramo">Gramo (g)</option>
                    <option value="kilogramo" title="Kilogramo">Kilogramo (kg)</option>
                    <option value="unidad" title="Unidad">Unidad</option>
                </select>
            </div>
        
            <div class="form-group">
                <label for="cantidad" title="Cantidad">Cantidad</label>
                <input type="number" placeholder="Cantidad" id="cantidad" name="cantidad" min="0" step="0.01" required title="Introduce la cantidad del producto">
            </div>
        
            <div class="form-group">
                <label for="precio" title="Precio">Precio ($ COP)</label>
                <input type="number" placeholder="Precio" id="precio" name="precio" min="0" step="100" required title="Introduce el precio del producto">
            </div>
        
            <div class="form-group">
                <label for="fecha_elaboracion" title="Fecha de elaboración">Fecha de Elaboración</label>
                <input type="date" placeholder="Fecha de Elaboración" id="fecha_elaboracion" name="fecha_elaboracion" required title="Selecciona la fecha de elaboración del producto">
            </div>
        
            <div class="form-group">
                <label for="fecha_vencimiento" title="Fecha de vencimiento">Fecha de Vencimiento</label>
                <input type="date" placeholder="Fecha de Vencimiento" id="fecha_vencimiento" name="fecha_vencimiento" required title="Selecciona la fecha de vencimiento del producto">
            </div>
        
            <div class="form-group">
                <label for="temperatura_conservacion" title="Temperatura de conservación">Temperatura de Conservación (°C)</label>
                <input type="number" placeholder="Temperatura" id="temperatura_conservacion" name="temperatura_conservacion" min="-20" max="30" step="0.1" required title="Introduce la temperatura de conservación">
            </div>            
        
            <div class="form-group">
                <label for="lote" title="Número de lote">Número de Lote</label>
                <input type="text" placeholder="Número de Lote" id="lote" name="lote" required pattern="[A-Za-z0-9]+" title="Ingresa el número de lote del producto">
            </div>
        
            <div class="form-group">
                <label for="codigo" title="Código del producto">Código del Producto</label>
                <input type="text" placeholder="Código" id="codigo" name="codigo" required pattern="[A-Za-z0-9]+" title="Ingresa el código del producto">
            </div>   
        
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" title="Crear producto">Crear Producto</button>
                <a href="{% url 'libreria:productos' %}" class="btn btn-secondary" title="Cancelar">Cancelar</a>
            </div>         
        </form>        

        <!-- Popup -->
        <div id="popup" class="popup">
            <div class="checkmark">
                <svg class="checkmark-svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16"/>
                </svg>
            </div>
            <p>Registro exitoso</p>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Función para limpiar mensajes de error
    const clearErrors = (input) => {
        input.next('.error-message').remove();
    };

    // Función para mostrar mensaje de error
    const showError = (input, message) => {
        clearErrors(input);
        input.after(`<span class="error-message" style="color:red;">${message}</span>`);
    };

    // Validación en tiempo real
    $('#nombre').on('input', function() {
        const val = $(this).val().trim();
        clearErrors($(this));
        if (!/^[A-Za-zÁáÉéÍíÓóÚúÑñ\s]+$/.test(val)) {
            showError($(this), 'El nombre solo puede contener letras y espacios.');
        }
    });

    $('#presentacion').on('input', function() {
        const val = $(this).val().trim();
        clearErrors($(this));
        if (!/^[A-Za-zÁáÉéÍíÓóÚúÑñ\s]+$/.test(val)) {
            showError($(this), 'La presentación solo puede contener letras y espacios.');
        } else if (val.length < 3 || val.length > 10) {
            showError($(this), 'La presentación debe tener entre 3 y 10 caracteres.');
        }
    });

    $('#lote').on('input', function() {
        const val = $(this).val().trim();
        clearErrors($(this));
        if (!/^[0-9]+$/.test(val)) {
            showError($(this), 'El lote debe contener solo números.');
        }
    });

    $('#codigo').on('input', function() {
        const val = $(this).val().trim();
        clearErrors($(this));
        if (!/^[0-9]+$/.test(val)) {
            showError($(this), 'El código debe contener solo números.');
        }
    });

    // Envío del formulario con AJAX
    $('#productoForm').on('submit', function(event) {
        event.preventDefault();

        // Validación previa (opcional, ya que el backend también valida)
        let isValid = true;
        $('.error-message').remove();

        const nombre = $('#nombre').val().trim();
        if (!/^[A-Za-zÁáÉéÍíÓóÚúÑñ\s]+$/.test(nombre)) {
            showError($('#nombre'), 'El nombre solo puede contener letras y espacios.');
            isValid = false;
        }

        const presentacion = $('#presentacion').val().trim();
        if (!/^[A-Za-zÁáÉéÍíÓóÚúÑñ\s]+$/.test(presentacion) || presentacion.length < 3 || presentacion.length > 10) {
            showError($('#presentacion'), 'La presentación debe tener entre 3 y 10 letras.');
            isValid = false;
        }

        const lote = $('#lote').val().trim();
        if (!/^[0-9]+$/.test(lote)) {
            showError($('#lote'), 'El lote debe ser numérico.');
            isValid = false;
        }

        const codigo = $('#codigo').val().trim();
        if (!/^[0-9]+$/.test(codigo)) {
            showError($('#codigo'), 'El código debe ser numérico.');
            isValid = false;
        }

        const categoria = $('#categoria').val();
        const unidadMedida = $('#unidad_medida').val();
        const cantidad = $('#cantidad').val();
        const precio = $('#precio').val();
        const fechaElab = $('#fecha_elaboracion').val();
        const fechaVenc = $('#fecha_vencimiento').val();
        const temp = $('#temperatura_conservacion').val();

        if (!categoria) { showError($('#categoria'), 'Selecciona una categoría.'); isValid = false; }
        if (!unidadMedida) { showError($('#unidad_medida'), 'Selecciona una unidad de medida.'); isValid = false; }
        if (!cantidad || parseFloat(cantidad) <= 0) { showError($('#cantidad'), 'Cantidad inválida.'); isValid = false; }
        if (!precio || parseFloat(precio) <= 0) { showError($('#precio'), 'Precio inválido.'); isValid = false; }
        if (!fechaElab) { showError($('#fecha_elaboracion'), 'Fecha de elaboración requerida.'); isValid = false; }
        if (!fechaVenc) { showError($('#fecha_vencimiento'), 'Fecha de vencimiento requerida.'); isValid = false; }
        if (!temp || isNaN(parseFloat(temp))) { showError($('#temperatura_conservacion'), 'Temperatura inválida.'); isValid = false; }

        if (!isValid) {
            toastr.error('Por favor corrige los errores antes de enviar.');
            return;
        }

        // Preparar datos
        const formData = new FormData(this);
        $.ajax({
            url: this.action,
            type: 'POST',
            data: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // Mostrar popup
                    $('#popup').fadeIn();
                    // Desplazar suavemente
                    $('html, body').animate({
                        scrollTop: $('#popup').offset().top - 200
                    }, 300);
                    // Redirigir después de 2 segundos
                    setTimeout(() => {
                        window.location.href = "{% url 'libreria:lista_productos' %}";
                    }, 2000);
                } else {
                    toastr.error('Error al guardar el producto. Verifica los datos.', 'Error');
                }
            },
            error: function(xhr) {
                if (xhr.status === 400 && xhr.responseJSON?.errors) {
                    toastr.error('Errores en el formulario. Revisa los campos.', 'Error de validación');
                } else {
                    toastr.error('Error de conexión con el servidor.', 'Error');
                }
            }
        });
    });
});
</script>

{% endblock %}
