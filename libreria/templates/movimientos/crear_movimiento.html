{% extends "navbar.html" %}
{% block titulo %}Crear Movimiento{% endblock %}
{% load static %}

{% block contenido %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link href="{% static 'css/crear_transaccion.css' %}?v={% now 'U' %}" rel="stylesheet" />

<div class="container">
    <form method='POST' id="transaction-form">
        {% csrf_token %}
        <h1>AGREGAR MOVIMIENTO</h1>

        <!-- Tipo de Movimiento -->
        <div class="form-group">
            <label for="tipo">Tipo de Movimiento</label>
            <select name="tipo" required id="tipo">
                <option value="" selected disabled>Selecciona una opción</option>
                <option value="Compra">Compra</option>
                <option value="Venta">Venta</option>
                <option value="Gasto">Gasto</option>
                <option value="Ingreso">Ingreso</option>
            </select>
        </div>

        <!-- Cliente -->
        <div class="form-group">
            <label for="cliente">Cliente</label>
            <select name="cliente" required id="cliente">
                <option value="" selected disabled>Selecciona un cliente</option>
                {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Productos -->
        <div id="productos-container">
            <h3>Productos</h3>
        </div>

        <button type="button" id="agregar-producto" class="btn-agregar">
            <i class="fas fa-plus"></i> Agregar otro producto
        </button>

        <!-- Monto Total -->
        <div class="form-group">
            <label for="monto_total">Monto Total ($ COP)</label>
            <input type="number" name="monto_total" step="0.01" id="monto-total" readonly>
        </div>

        <div class="form-group">
            <label for="descripcion">Descripción</label>
            <textarea name="descripcion" placeholder="Ingresa una descripción" required id="descripcion" rows="3"></textarea>
        </div>

        <div class="form-group">
            <label for="fecha">Fecha</label>
            <input type="date" name="fecha" required id="fecha">
        </div>

        <div class="button-group">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Registrar Movimiento
            </button>
            <a class="btn btn-warning" href="{% url 'libreria:contabilidad' %}">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
        
    </form>
</div>

<!-- ==================== SCRIPT ==================== -->
<script>
$(document).ready(function() {
    const productos = JSON.parse('{{ productos_json|escapejs }}');
    let index = 0;

    // 🔹 Función que genera un bloque de producto con todas las opciones
    function crearProductoItem() {
        const opciones = productos.map(p => 
            `<option value="${p.id}" data-precio="${p.precio}">${p.nombre} - $${p.precio}</option>`
        ).join('');

        return `
            <div class="producto-item" data-index="${index}">
                <div class="producto-row">
                    <select name="producto[]" required class="producto-select">
                        <option value="" selected disabled>Selecciona un producto</option>
                        ${opciones}
                    </select>
                    <input type="number" name="cantidad[]" placeholder="Cantidad" required min="1" class="cantidad-input">
                    ${index === 0 ? '' : '<button type="button" class="btn-eliminar-producto"><i class="fas fa-trash"></i></button>'}
                </div>
            </div>`;
    }

    // 🔹 Agregar el primer producto al cargar
    $('#productos-container').append(crearProductoItem());

    // 🔹 Agregar otro producto
    $('#agregar-producto').click(function() {
        index++;
        $('#productos-container').append(crearProductoItem());
        actualizarOpcionesProductos(); // evitar duplicados desde el inicio
    });

    // 🔹 Eliminar producto
    $(document).on('click', '.btn-eliminar-producto', function() {
        $(this).closest('.producto-item').remove();
        actualizarMontoTotal();
        actualizarOpcionesProductos();
    });

    // 🔹 Actualizar monto total
    function actualizarMontoTotal() {
        let total = 0;
        $('.producto-item').each(function() {
            const select = $(this).find('.producto-select');
            const cantidad = parseInt($(this).find('.cantidad-input').val()) || 0;
            const precio = parseFloat(select.find(':selected').data('precio')) || 0;
            total += cantidad * precio;
        });
        $('#monto-total').val(total.toFixed(2));
    }

    // 🔹 Evitar productos duplicados
    function actualizarOpcionesProductos() {
        const seleccionados = $('.producto-select').map(function() {
            return $(this).val();
        }).get().filter(v => v); // solo los que tienen valor

        $('.producto-select').each(function() {
            const valorActual = $(this).val();
            $(this).find('option').each(function() {
                const valor = $(this).attr('value');
                if (valor && seleccionados.includes(valor) && valor !== valorActual) {
                    $(this).prop('disabled', true);
                } else {
                    $(this).prop('disabled', false);
                }
            });
        });
    }

    // 🔹 Escuchar cambios
    $(document).on('change input', '.producto-select, .cantidad-input', function() {
        actualizarMontoTotal();
        actualizarOpcionesProductos();
    });
});
</script>

<!-- ==================== ESTILOS ==================== -->
<style>
.producto-item {
    margin-bottom: 15px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.producto-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.producto-row select,
.producto-row input {
    flex: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 10px;
}

.btn-eliminar-producto {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #dc3545;
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
}

.btn-eliminar-producto:hover {
    background: #c82333;
}

.btn-agregar {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 20px;
}

.btn-agregar:hover {
    background: #218838;
}
</style>
{% endblock %}
