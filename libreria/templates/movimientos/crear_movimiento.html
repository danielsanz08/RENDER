{% extends "navbar.html" %}
{% block titulo %}Crear Movimiento{% endblock %}
{% load static %}

{% block contenido %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link href="{% static 'css/crear_transaccion.css' %}?v={% now 'U' %}" rel="stylesheet" />

<div class="container">
    <form method='POST' id="transaction-form">
        {% csrf_token %}
        <h1>AGREGAR MOVIMIENTO</h1>

        <!-- Tipo de Movimiento -->
        <div class="form-group">
            <label for="tipo">Tipo de Movimiento</label>
            <select name="tipo" required id="tipo">
                <option value="" selected disabled>Selecciona una opci贸n</option>
                <option value="Compra">Compra</option>
                <option value="Venta">Venta</option>
                <option value="Gasto">Gasto</option>
                <option value="Ingreso">Ingreso</option>
            </select>
        </div>

        <!-- Cliente (solo para Venta) -->
        <div class="form-group" id="cliente-group" style="display: none;">
            <label for="cliente">Cliente</label>
            <select name="cliente" id="cliente">
                <option value="" selected disabled>Selecciona un cliente</option>
                {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Proveedor (solo para Compra) -->
        <div class="form-group" id="proveedor-group" style="display: none;">
            <label for="proveedor">Proveedor</label>
            <select name="proveedor" id="proveedor">
                <option value="" selected disabled>Selecciona un proveedor</option>
                {% for proveedor in proveedores %}
                    <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Productos (solo para Venta) -->
        <div id="productos-container" style="display: none;">
            <h3>Productos Vendidos</h3>
        </div>

        <button type="button" id="agregar-producto" class="btn-agregar" style="display: none;">
            <i class="fas fa-plus"></i> Agregar otro producto
        </button>

        <!-- Insumos (solo para Compra y Gasto) -->
        <div id="insumos-container" style="display: none;">
            <h3>Insumos</h3>
        </div>

        <button type="button" id="agregar-insumo" class="btn-agregar" style="display: none;">
            <i class="fas fa-plus"></i> Agregar otro insumo
        </button>

        <!-- Productos obtenidos (solo para Gasto) -->
        <div id="productos-obtenidos-container" style="display: none;">
            <h3>Productos Obtenidos</h3>
        </div>

        <button type="button" id="agregar-producto-obtenido" class="btn-agregar" style="display: none;">
            <i class="fas fa-plus"></i> Agregar otro producto obtenido
        </button>

        <!-- Monto Total -->
        <div class="form-group">
            <label for="monto_total">Monto Total ($ COP)</label>
            <input type="number" name="monto_total" step="0.01" id="monto-total" readonly>
        </div>

        <div class="form-group">
            <label for="descripcion">Descripci贸n</label>
            <textarea name="descripcion" placeholder="Ingresa una descripci贸n" required id="descripcion" rows="3"></textarea>
        </div>

        <div class="form-group">
            <label for="fecha">Fecha</label>
            <input type="date" name="fecha" required id="fecha">
        </div>

        <div class="button-group">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Registrar Movimiento
            </button>
            <a class="btn btn-warning" href="{% url 'libreria:contabilidad' %}">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
        
    </form>
      <div id="popup" class="popup">
        <div class="checkmark">
            <svg class="checkmark-svg" viewBox="0 0 52 52">
                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16"/>
            </svg>
        </div>
        <p>Registro exitoso</p>
    </div>
</div>

<!-- ==================== SCRIPT MEJORADO ==================== -->
<script>
$(document).ready(function() {
    const productos = JSON.parse('{{ productos_json|escapejs }}');
    const insumos = JSON.parse('{{ insumos_json|escapejs }}');
    let productoIndex = 0;
    let insumoIndex = 0;
    let productoObtenidoIndex = 0;

    //  Mostrar/ocultar campos seg煤n tipo de movimiento
    $('#tipo').change(function() {
        const tipo = $(this).val();
        
        // Resetear y ocultar todos los campos
        resetearCampos();
        
        switch(tipo) {
            case 'Compra':
                mostrarCompra();
                break;
            case 'Venta':
                mostrarVenta();
                break;
            case 'Gasto':
                mostrarGasto();
                break;
            case 'Ingreso':
                mostrarIngreso();
                break;
        }
        
        actualizarMontoTotal();
    });

    function resetearCampos() {
        // Ocultar todos los grupos
        $('#cliente-group, #proveedor-group, #productos-container, #insumos-container, #productos-obtenidos-container').hide();
        $('#agregar-producto, #agregar-insumo, #agregar-producto-obtenido').hide();
        
        // Limpiar contenedores
        $('#productos-container').empty().append('<h3>Productos Vendidos</h3>');
        $('#insumos-container').empty().append('<h3>Insumos</h3>');
        $('#productos-obtenidos-container').empty().append('<h3>Productos Obtenidos</h3>');
        
        // Resetear 铆ndices
        productoIndex = 0;
        insumoIndex = 0;
        productoObtenidoIndex = 0;
        
        // Limpiar selects
        $('#cliente, #proveedor').val('');
    }

    function mostrarCompra() {
        $('#proveedor-group').show();
        $('#insumos-container').show();
        $('#agregar-insumo').show();
        $('#insumos-container').append(crearInsumoItem());
    }

    function mostrarVenta() {
        $('#cliente-group').show();
        $('#productos-container').show();
        $('#agregar-producto').show();
        $('#productos-container').append(crearProductoItem());
    }

    function mostrarGasto() {
        $('#insumos-container').show();
        $('#productos-obtenidos-container').show();
        $('#agregar-insumo').show();
        $('#agregar-producto-obtenido').show();
        $('#insumos-container').append(crearInsumoItem());
        $('#productos-obtenidos-container').append(crearProductoObtenidoItem());
    }

    function mostrarIngreso() {
        // Para ingresos, solo mostrar monto total, descripci贸n y fecha
    }

    //  Funci贸n que genera un bloque de producto para ventas
    function crearProductoItem() {
        const opciones = productos.map(p => 
            `<option value="${p.id}" data-precio="${p.precio}">${p.nombre} - $${p.precio}</option>`
        ).join('');

        return `
            <div class="producto-item" data-index="${productoIndex}">
                <div class="producto-row">
                    <select name="producto_venta[]" required class="producto-select">
                        <option value="" selected disabled>Selecciona un producto</option>
                        ${opciones}
                    </select>
                    <input type="number" name="cantidad_producto[]" placeholder="Cantidad" required min="1" class="cantidad-input">
                    ${productoIndex === 0 ? '' : '<button type="button" class="btn-eliminar"><i class="fas fa-trash"></i></button>'}
                </div>
            </div>`;
    }

    //  Funci贸n que genera un bloque de insumo para compras y gastos
    function crearInsumoItem() {
        const opciones = insumos.map(i => 
            `<option value="${i.id}" data-precio="${i.precio}">${i.nombre} - $${i.precio}</option>`
        ).join('');

        return `
            <div class="insumo-item" data-index="${insumoIndex}">
                <div class="insumo-row">
                    <select name="insumo[]" required class="insumo-select">
                        <option value="" selected disabled>Selecciona un insumo</option>
                        ${opciones}
                    </select>
                    <input type="number" name="cantidad_insumo[]" placeholder="Cantidad" required min="1" class="cantidad-input">
                    ${insumoIndex === 0 ? '' : '<button type="button" class="btn-eliminar"><i class="fas fa-trash"></i></button>'}
                </div>
            </div>`;
    }

    //  Funci贸n que genera un bloque de producto obtenido para gastos
    function crearProductoObtenidoItem() {
        const opciones = productos.map(p => 
            `<option value="${p.id}" data-precio="${p.precio}">${p.nombre} - $${p.precio}</option>`
        ).join('');

        return `
            <div class="producto-obtenido-item" data-index="${productoObtenidoIndex}">
                <div class="producto-row">
                    <select name="producto_obtenido[]" required class="producto-obtenido-select">
                        <option value="" selected disabled>Selecciona un producto</option>
                        ${opciones}
                    </select>
                    <input type="number" name="cantidad_producto_obtenido[]" placeholder="Cantidad" required min="1" class="cantidad-input">
                    ${productoObtenidoIndex === 0 ? '' : '<button type="button" class="btn-eliminar"><i class="fas fa-trash"></i></button>'}
                </div>
            </div>`;
    }

    //  Agregar productos para ventas
    $('#agregar-producto').click(function() {
        productoIndex++;
        $('#productos-container').append(crearProductoItem());
        actualizarOpcionesProductos();
    });

    //  Agregar insumos para compras y gastos
    $('#agregar-insumo').click(function() {
        insumoIndex++;
        $('#insumos-container').append(crearInsumoItem());
        actualizarOpcionesInsumos();
    });

    //  Agregar productos obtenidos para gastos
    $('#agregar-producto-obtenido').click(function() {
        productoObtenidoIndex++;
        $('#productos-obtenidos-container').append(crearProductoObtenidoItem());
        actualizarOpcionesProductosObtenidos();
    });

    //  Eliminar elementos
    $(document).on('click', '.btn-eliminar', function() {
        $(this).closest('.producto-item, .insumo-item, .producto-obtenido-item').remove();
        actualizarMontoTotal();
        actualizarTodasLasOpciones();
    });

    //  Actualizar monto total
    function actualizarMontoTotal() {
        let total = 0;
        
        // Sumar productos de ventas
        $('.producto-item').each(function() {
            const select = $(this).find('.producto-select');
            const cantidad = parseInt($(this).find('.cantidad-input').val()) || 0;
            const precio = parseFloat(select.find(':selected').data('precio')) || 0;
            total += cantidad * precio;
        });
        
        // Sumar insumos de compras y gastos
        $('.insumo-item').each(function() {
            const select = $(this).find('.insumo-select');
            const cantidad = parseInt($(this).find('.cantidad-input').val()) || 0;
            const precio = parseFloat(select.find(':selected').data('precio')) || 0;
            total += cantidad * precio;
        });
        
        $('#monto-total').val(total.toFixed(2));
    }

    //  Funciones para evitar duplicados
    function actualizarOpcionesProductos() {
        const seleccionados = $('.producto-select').map(function() {
            return $(this).val();
        }).get().filter(v => v);

        $('.producto-select').each(function() {
            const valorActual = $(this).val();
            $(this).find('option').each(function() {
                const valor = $(this).attr('value');
                if (valor && seleccionados.includes(valor) && valor !== valorActual) {
                    $(this).prop('disabled', true);
                } else {
                    $(this).prop('disabled', false);
                }
            });
        });
    }

    function actualizarOpcionesInsumos() {
        const seleccionados = $('.insumo-select').map(function() {
            return $(this).val();
        }).get().filter(v => v);

        $('.insumo-select').each(function() {
            const valorActual = $(this).val();
            $(this).find('option').each(function() {
                const valor = $(this).attr('value');
                if (valor && seleccionados.includes(valor) && valor !== valorActual) {
                    $(this).prop('disabled', true);
                } else {
                    $(this).prop('disabled', false);
                }
            });
        });
    }

    function actualizarOpcionesProductosObtenidos() {
        const seleccionados = $('.producto-obtenido-select').map(function() {
            return $(this).val();
        }).get().filter(v => v);

        $('.producto-obtenido-select').each(function() {
            const valorActual = $(this).val();
            $(this).find('option').each(function() {
                const valor = $(this).attr('value');
                if (valor && seleccionados.includes(valor) && valor !== valorActual) {
                    $(this).prop('disabled', true);
                } else {
                    $(this).prop('disabled', false);
                }
            });
        });
    }

    function actualizarTodasLasOpciones() {
        actualizarOpcionesProductos();
        actualizarOpcionesInsumos();
        actualizarOpcionesProductosObtenidos();
    }

    //  Escuchar cambios en todos los campos
    $(document).on('change input', '.producto-select, .insumo-select, .producto-obtenido-select, .cantidad-input', function() {
        actualizarMontoTotal();
        actualizarTodasLasOpciones();
    });
});
$(document).ready(function() {
    $('#transaction-form').on('submit', function(event) {
        event.preventDefault(); // Evita el env铆o inmediato del formulario

        let errorMessages = [];
        const descripcion = $('textarea[name="descripcion"]').val().trim();

        // Validaciones para la descripci贸n
        if (descripcion.length < 5) {
            errorMessages.push('La descripci贸n debe tener al menos 5 caracteres.');
        }
        if (descripcion.length > 20) {
            errorMessages.push('La descripci贸n no puede contener m谩s de 20 caracteres.');
        }

        // Si hay errores de validaci贸n, mostrar todos los mensajes
        if (errorMessages.length > 0) {
            toastr.error(errorMessages.join('<br>'), 'Error', {
                closeButton: true,
                progressBar: true,
                timeOut: 5000,
                positionClass: 'toast-bottom-right'
            });

            // Ajustar la posici贸n del toast despu茅s de que se muestre
            setTimeout(() => {
                $('.toast').css('top', '-50px'); // Ajusta el valor a la posici贸n deseada
            }, 0);

            return; // Termina aqu铆 si hay errores
        }

        // Si no hay errores, muestra el popup de 茅xito
        $('#popup').fadeIn(); // Muestra el popup

        setTimeout(function() {
            $('html, body').animate({
                scrollTop: $('#popup').offset().top - 300 // Desplazamiento suave hacia el popup
            }, 300);

            setTimeout(() => {
                $('#popup').fadeOut(); // Oculta el popup despu茅s de 2 segundos
                // Enviar el formulario despu茅s de que el popup se oculta
                $('#transaction-form')[0].submit(); 
            }, 2000); // Duraci贸n del popup (2 segundos)
        });
    });
});

</script>

<!-- ==================== ESTILOS MEJORADOS ==================== -->
<style>
/* ==================== ESTILOS PARA PRODUCTOS, INSUMOS Y PRODUCTOS OBTENIDOS ==================== */

.producto-item, .insumo-item, .producto-obtenido-item {
    margin-bottom: 15px;
    padding: 12px;
    border: none; /* Sin borde */
    border-radius: 20px; /* Bordes redondeados */
    background-color: #fff; /* Fondo blanco */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombra sutil */
    opacity: 0; /* Inicia oculto */
    transform: translateY(10px); /* Desplazado hacia abajo */
    animation: fadeIn 0.5s forwards; /* Animaci贸n de entrada */
}

.producto-row, .insumo-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.producto-row select, .producto-row input,
.insumo-row select, .insumo-row input {
    flex: 1;
    padding: 10px;
    border: none; /* Sin borde */
    border-radius: 20px; /* Bordes redondeados */
    background-color: #f8f9fa; /* Fondo gris claro */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombra sutil */
    transition: all 0.3s ease; /* Transici贸n suave */
    font-size: 16px;
    height: 50px; /* Altura consistente */
}

/* Efecto en el foco para selects e inputs */
.producto-row select:focus, .producto-row input:focus,
.insumo-row select:focus, .insumo-row input:focus {
    outline: none; /* Sin borde por defecto */
    box-shadow: 0 0 10px #01AB7B; /* Sombra verde al hacer foco */
    background-color: #fff; /* Fondo blanco al enfocar */
}

.btn-eliminar {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #dc3545;
    color: #fff;
    border: none;
    padding: 10px 15px;
    border-radius: 20px; /* Bordes redondeados */
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    font-size: 16px;
    height: 50px; /* Altura consistente */
}

.btn-eliminar:hover {
    background: #c82333;
    transform: scale(1.05); /* Efecto de aumento al pasar el mouse */
}

.btn-agregar {
    background: #01AB7B; /* Color verde consistente */
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 20px; /* Bordes redondeados */
    cursor: pointer;
    margin-bottom: 20px;
    transition: background-color 0.3s ease, transform 0.2s ease;
    font-size: 18px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombra sutil */
    opacity: 0; /* Inicia oculto */
    transform: translateY(10px); /* Desplazado hacia abajo */
    animation: fadeIn 0.5s forwards; /* Animaci贸n de entrada */
    animation-delay: 0.4s; /* Retardo en la animaci贸n */
}

.btn-agregar:hover {
    background: #00995c; /* Color m谩s oscuro al pasar el mouse */
    transform: scale(1.05); /* Efecto de aumento al pasar el mouse */
}

/* Estilos para diferentes secciones */
#productos-container h3 {
    color: #007bff;
    font-size: 24px;
    margin-bottom: 15px;
    text-transform: uppercase;
    opacity: 0; /* Inicia oculto */
    transform: translateY(10px); /* Desplazado hacia abajo */
    animation: fadeIn 0.5s forwards; /* Animaci贸n de entrada */
    animation-delay: 0.2s; /* Retardo en la animaci贸n */
}

#insumos-container h3 {
    color: #28a745;
    font-size: 24px;
    margin-bottom: 15px;
    text-transform: uppercase;
    opacity: 0; /* Inicia oculto */
    transform: translateY(10px); /* Desplazado hacia abajo */
    animation: fadeIn 0.5s forwards; /* Animaci贸n de entrada */
    animation-delay: 0.2s; /* Retardo en la animaci贸n */
}

#productos-obtenidos-container h3 {
    color: #ffc107;
    font-size: 24px;
    margin-bottom: 15px;
    text-transform: uppercase;
    opacity: 0; /* Inicia oculto */
    transform: translateY(10px); /* Desplazado hacia abajo */
    animation: fadeIn 0.5s forwards; /* Animaci贸n de entrada */
    animation-delay: 0.2s; /* Retardo en la animaci贸n */
}

/* Animaci贸n de entrada para los elementos */
@keyframes fadeIn {
    to {
        opacity: 1;
        transform: translateY(0); /* Regresa a su posici贸n original */
    }
}

/* Estilos responsivos para pantallas peque帽as */
@media (max-width: 768px) {
    .producto-row, .insumo-row {
        flex-direction: column;
        gap: 8px;
    }
    
    .producto-row select, .producto-row input,
    .insumo-row select, .insumo-row input {
        width: 100%;
    }
    
    .btn-eliminar {
        width: 100%;
        justify-content: center;
    }
    
    .btn-agregar {
        width: 100%;
        text-align: center;
    }
}

/* Efectos de hover para los contenedores de items */
.producto-item:hover, .insumo-item:hover, .producto-obtenido-item:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); /* Sombra m谩s pronunciada al hover */
    transform: translateY(-2px); /* Efecto de elevaci贸n */
    transition: all 0.3s ease;
}

/* Estilos para los placeholders */
.producto-row input::placeholder,
.insumo-row input::placeholder {
    color: rgba(0, 0, 0, 0.4); /* Color del placeholder */
    opacity: 1;
}

/* Estilos para los selects */
.producto-row select,
.insumo-row select {
    appearance: none; /* Elimina el estilo por defecto del navegador */
    background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23001AB7B' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 12px;
    padding-right: 40px; /* Espacio para la flecha */
}

/* Estilos para los botones de agregar cuando est谩n deshabilitados */
.btn-agregar:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.btn-agregar:disabled:hover {
    background-color: #6c757d;
    transform: none;
}
/* Estilos para el popup */
.popup {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    z-index: 9999;
}

/* Estilos de alertas (茅xito y error) */
.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.checkmark {
    margin: 10px auto;
}

.checkmark-svg {
    width: 50px;
    height: 50px;
    stroke: #4CAF50;
    stroke-width: 4;
    stroke-linecap: round;
    stroke-linejoin: round;
}

.checkmark-circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    animation: drawCircle 0.6s ease-out forwards;
}

.checkmark-check {
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: drawCheck 0.3s 0.6s ease-out forwards;
}

@keyframes drawCircle {
    100% {
        stroke-dashoffset: 0;
    }
}

@keyframes drawCheck {
    100% {
        stroke-dashoffset: 0;
    }
}
</style>
{% endblock %}